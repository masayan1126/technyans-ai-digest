name: Daily AI News Generation

on:
  schedule:
    - cron: '0 0 * * *'  # æ¯æ—¥ 0:00 UTC = 9:00 JST
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½ã«

jobs:
  generate-news:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      id-token: write

    steps:
      - uses: actions/checkout@v4

      - name: Create branch
        id: branch
        run: |
          BRANCH_NAME="ai-news/$(date +%Y%m%d-%H%M%S)"
          echo "name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          git checkout -b $BRANCH_NAME

      - name: Run Claude Code Action
        id: claude
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            Tavily MCP ã‚’ä½¿ã£ã¦ä»Šæ—¥ã®æœ€æ–° AI ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚’æ¤œç´¢ã—ã€
            é‡è¦ãªãƒ‹ãƒ¥ãƒ¼ã‚¹ã«ã¤ã„ã¦è¨˜äº‹ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

            ãƒ«ãƒ¼ãƒ«ï¼š
            - å„ãƒˆãƒ”ãƒƒã‚¯ã”ã¨ã«ç‹¬ç«‹ã—ãŸè¨˜äº‹ã‚’ä½œæˆ
            - å¿…ãš ja.md ã¨ en.md ã®ä¸¡æ–¹ã‚’ä½œæˆ
            - src/content/articles/YYYYMMDD/[article-slug]/ ã«é…ç½®
            - TAGS.md ã®ã‚¿ã‚°ã®ã¿ä½¿ç”¨
            - npm run validate-tags ã§æ¤œè¨¼
            - è¨˜äº‹ä½œæˆå¾Œã€git add ã¨ git commit ã‚’å®Ÿè¡Œ
          claude_args: "--model claude-haiku-4-5-20250929 --allowedTools Bash,Edit,Write,Read,WebSearch,mcp__tavily-mcp__tavily-search,mcp__tavily-mcp__tavily-extract"
        env:
          TAVILY_API_KEY: ${{ secrets.TAVILY_API_KEY }}

      - name: Create Pull Request
        id: pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # æœªã‚³ãƒŸãƒƒãƒˆã®å¤‰æ›´ãŒã‚ã‚‹å ´åˆã¯ã‚³ãƒŸãƒƒãƒˆ
          if [ -n "$(git status --porcelain)" ]; then
            git add -A
            git commit -m "Add AI news articles for $(date +%Y-%m-%d)"
          fi

          # main ã¨ã®å·®åˆ†ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          COMMITS_AHEAD=$(git rev-list --count origin/main..HEAD 2>/dev/null || echo "0")

          if [ "$COMMITS_AHEAD" -gt "0" ]; then
            git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
            git push -u origin ${{ steps.branch.outputs.name }}

            # ä½œæˆã•ã‚ŒãŸè¨˜äº‹ã®ä¸€è¦§ã‚’å–å¾—
            ARTICLES=$(git diff --name-only origin/main..HEAD | grep -E "^src/content/articles/.*/ja\.md$" | head -10)

            # è¨˜äº‹ã‚¿ã‚¤ãƒˆãƒ«ã‚’æŠ½å‡º
            ARTICLE_SUMMARY=""
            for file in $ARTICLES; do
              if [ -f "$file" ]; then
                TITLE=$(grep -m1 "^title:" "$file" | sed 's/title: //' | tr -d '"')
                ARTICLE_SUMMARY="${ARTICLE_SUMMARY}- ${TITLE}\n"
              fi
            done

            # PR ä½œæˆ
            PR_URL=$(gh pr create \
              --title "AI News: $(date +%Y-%m-%d)" \
              --body "## Summary

            AI ãƒ‹ãƒ¥ãƒ¼ã‚¹è¨˜äº‹ã®è‡ªå‹•ç”Ÿæˆ

            ## ä½œæˆã•ã‚ŒãŸè¨˜äº‹

            ${ARTICLE_SUMMARY}

            ## Generated by

            GitHub Actions + Claude Code Action

            ---
            *This PR was automatically generated.*" \
              --base main \
              --head ${{ steps.branch.outputs.name }} 2>&1 || echo "PR_FAILED")

            if [[ "$PR_URL" == *"PR_FAILED"* ]]; then
              echo "pr_created=false" >> $GITHUB_OUTPUT
              echo "pr_url=" >> $GITHUB_OUTPUT
            else
              echo "pr_created=true" >> $GITHUB_OUTPUT
              echo "pr_url=$PR_URL" >> $GITHUB_OUTPUT
            fi
            echo "article_summary<<EOF" >> $GITHUB_OUTPUT
            echo -e "$ARTICLE_SUMMARY" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            echo "commits_ahead=$COMMITS_AHEAD" >> $GITHUB_OUTPUT
          else
            echo "pr_created=false" >> $GITHUB_OUTPUT
            echo "commits_ahead=0" >> $GITHUB_OUTPUT
            echo "article_summary=ãªã—" >> $GITHUB_OUTPUT
          fi

      - name: Notify Discord (Success)
        if: success() && steps.pr.outputs.commits_ahead != '0'
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          PR_URL="${{ steps.pr.outputs.pr_url }}"
          ARTICLE_SUMMARY="${{ steps.pr.outputs.article_summary }}"

          # Discord ã«é€šçŸ¥
          curl -H "Content-Type: application/json" \
            -X POST \
            -d "{
              \"embeds\": [{
                \"title\": \"âœ… AI ãƒ‹ãƒ¥ãƒ¼ã‚¹è¨˜äº‹ãŒç”Ÿæˆã•ã‚Œã¾ã—ãŸ\",
                \"description\": \"æœ¬æ—¥ã® AI ãƒ‹ãƒ¥ãƒ¼ã‚¹è¨˜äº‹ãŒè‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ãƒãƒ¼ã‚¸ã—ã¦ãã ã•ã„ã€‚\",
                \"color\": 5763719,
                \"fields\": [
                  {
                    \"name\": \"ğŸ“° ä½œæˆã•ã‚ŒãŸè¨˜äº‹\",
                    \"value\": \"${ARTICLE_SUMMARY:-è¨˜äº‹æƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ}\",
                    \"inline\": false
                  },
                  {
                    \"name\": \"ğŸ”— Pull Request\",
                    \"value\": \"${PR_URL:-ãƒ–ãƒ©ãƒ³ãƒ: ${{ steps.branch.outputs.name }}}\",
                    \"inline\": false
                  }
                ],
                \"footer\": {
                  \"text\": \"GitHub Actions + Claude Code Action\"
                },
                \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"
              }]
            }" \
            "$DISCORD_WEBHOOK_URL"

      - name: Notify Discord (No Articles)
        if: success() && steps.pr.outputs.commits_ahead == '0'
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          curl -H "Content-Type: application/json" \
            -X POST \
            -d "{
              \"embeds\": [{
                \"title\": \"â„¹ï¸ æœ¬æ—¥ã® AI ãƒ‹ãƒ¥ãƒ¼ã‚¹\",
                \"description\": \"æœ¬æ—¥ã¯æ–°ã—ã„è¨˜äº‹ãŒç”Ÿæˆã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚\",
                \"color\": 9807270,
                \"footer\": {
                  \"text\": \"GitHub Actions + Claude Code Action\"
                },
                \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"
              }]
            }" \
            "$DISCORD_WEBHOOK_URL"

      - name: Notify Discord (Failure)
        if: failure()
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          curl -H "Content-Type: application/json" \
            -X POST \
            -d "{
              \"embeds\": [{
                \"title\": \"âŒ AI ãƒ‹ãƒ¥ãƒ¼ã‚¹ç”ŸæˆãŒå¤±æ•—ã—ã¾ã—ãŸ\",
                \"description\": \"ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®å®Ÿè¡Œä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚\",
                \"color\": 15548997,
                \"fields\": [
                  {
                    \"name\": \"ğŸ” è©³ç´°\",
                    \"value\": \"[GitHub Actions ãƒ­ã‚°ã‚’ç¢ºèª](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})\",
                    \"inline\": false
                  }
                ],
                \"footer\": {
                  \"text\": \"GitHub Actions + Claude Code Action\"
                },
                \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"
              }]
            }" \
            "$DISCORD_WEBHOOK_URL"
