---
import BaseLayout from '../../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const articles = await getCollection('articles');

  return articles.map((article) => {
    // 新しい構造: 20251118/slug/lang -> lang, 20251118/slug
    const locale = article.data.locale || 'en';
    const slugParts = article.slug.split('/');

    // slug形式: "20251118/article-name/ja" または "20251118/article-name/en"
    // 必要なのは "article-name" の部分
    const articleSlug = slugParts.length >= 2 ? slugParts.slice(0, -1).join('/') : article.slug;

    return {
      params: {
        lang: locale,
        slug: articleSlug
      },
      props: { article },
    };
  });
}

const { article } = Astro.props;
const { lang } = Astro.params;
const { Content } = await article.render();

// 多言語対応のテキスト
const locale = lang as 'ja' | 'en';
const translations = {
  ja: {
    home: 'ホーム',
    articles: '記事一覧',
    backToArticles: '← 記事一覧に戻る',
    tableOfContents: '目次',
  },
  en: {
    home: 'Home',
    articles: 'Articles',
    backToArticles: '← Back to All Articles',
    tableOfContents: 'Table of Contents',
  },
};
const t = translations[locale];

// 他の言語版へのリンクを生成
const otherLang = locale === 'ja' ? 'en' : 'ja';
const slugParts = article.slug.split('/');
const articleSlug = slugParts.length >= 2 ? slugParts.slice(0, -1).join('/') : article.slug;
const otherLangUrl = `/articles/${otherLang}/${articleSlug}`;
---

<BaseLayout
  title={`${article.data.title} - Technyan's AI Digests`}
  description={article.data.description}
  ogTitle={article.data.title}
  ogDescription={article.data.description}
  ogType="article"
>
  <article class="container-custom py-12 md:py-20">
    <!-- Language Switcher -->
    <div class="mb-4 text-right">
      <a href={otherLangUrl} class="text-sm opacity-60 hover:opacity-100 transition-opacity">
        {otherLang === 'ja' ? '日本語' : 'English'}
      </a>
    </div>

    <!-- Breadcrumb -->
    <nav class="mb-8 text-sm opacity-60">
      <a href="/" class="hover:underline">{t.home}</a>
      <span class="mx-2">/</span>
      <a href="/articles" class="hover:underline">{t.articles}</a>
      <span class="mx-2">/</span>
      <span>{article.data.category}</span>
    </nav>

    <!-- Article Header -->
    <header class="max-w-4xl mb-12">
      <div class="mb-6">
        <span class="inline-block px-4 py-2 bg-navy text-cream text-sm border-1.5 border-navy">
          {article.data.category}
        </span>
      </div>

      <h1 class="text-4xl md:text-5xl lg:text-6xl font-bold mb-6 leading-tight">
        {article.data.title}
      </h1>

      <p class="text-xl md:text-2xl leading-relaxed mb-6 opacity-80">
        {article.data.description}
      </p>

      <div class="flex flex-wrap items-center gap-4 text-sm opacity-60 border-t-1.5 border-navy pt-6">
        <time datetime={article.data.date.toISOString()}>
          {article.data.date.toLocaleDateString(locale === 'ja' ? 'ja-JP' : 'en-US', {
            year: 'numeric',
            month: 'long',
            day: 'numeric',
          })}
        </time>
        {article.data.tags && (
          <div class="flex flex-wrap gap-2">
            {article.data.tags.map((tag: string) => (
              <span class="px-2 py-1 bg-cream border-1.5 border-navy text-xs whitespace-nowrap">
                {tag}
              </span>
            ))}
          </div>
        )}
      </div>
    </header>

    <!-- Main Layout with TOC -->
    <div class="relative flex gap-8">
      <!-- Article Content -->
      <div class="flex-1 max-w-4xl prose prose-lg prose-navy">
        <div class="article-content text-base md:text-lg leading-relaxed">
          <Content />
        </div>

        <!-- Back to Articles -->
        <div class="mt-12 pt-12 border-t-1.5 border-navy">
          <a href="/articles" class="btn-secondary">
            {t.backToArticles}
          </a>
        </div>
      </div>

      <!-- Table of Contents (PC only) -->
      <aside class="hidden xl:block w-64 flex-shrink-0">
        <nav id="toc" class="sticky top-8">
          <div class="border-1.5 border-navy bg-cream p-6">
            <h2 class="text-lg font-bold mb-4 text-navy">{t.tableOfContents}</h2>
            <ul id="toc-list" class="space-y-2 text-sm">
              <!-- TOC items will be generated by JavaScript -->
            </ul>
          </div>
        </nav>
      </aside>
    </div>
  </article>
</BaseLayout>

<style>
  .article-content :global(h1),
  .article-content :global(h2),
  .article-content :global(h3) {
    margin-top: 2rem;
    margin-bottom: 1rem;
  }

  .article-content :global(p) {
    margin-bottom: 1.5rem;
  }

  .article-content :global(ul),
  .article-content :global(ol) {
    margin-bottom: 1.5rem;
    padding-left: 2rem;
  }

  .article-content :global(li) {
    margin-bottom: 0.5rem;
  }

  .article-content :global(strong) {
    font-weight: 600;
  }

  .article-content :global(code) {
    background-color: rgba(12, 35, 64, 0.1);
    padding: 0.2rem 0.4rem;
    border-radius: 2px;
    font-size: 0.9em;
  }

  .article-content :global(pre) {
    background-color: #0c2340;
    color: #fff6d0;
    padding: 1.5rem;
    overflow-x: auto;
    margin-bottom: 1.5rem;
    border: 1.5px solid #0c2340;
  }

  .article-content :global(blockquote) {
    border-left: 4px solid #0c2340;
    padding-left: 1.5rem;
    margin: 1.5rem 0;
    opacity: 0.8;
  }

  /* テクにゃん.のコメント専用スタイル */
  .article-content :global(h2:has(+ blockquote):not(:has(+ :not(blockquote)))),
  .article-content :global(h2):has-text('テクにゃん.のコメント'),
  .article-content :global(h2):has-text("Tech-nyan's Comment") {
    position: relative;
    padding-left: 4rem;
  }

  .article-content :global(h2):has-text('テクにゃん.のコメント')::before,
  .article-content :global(h2):has-text("Tech-nyan's Comment")::before {
    content: '';
    position: absolute;
    left: 0;
    top: 50%;
    transform: translateY(-50%);
    width: 3rem;
    height: 3rem;
    background-image: url('/technyan.webp');
    background-size: contain;
    background-repeat: no-repeat;
    background-position: center;
  }

  /* テクにゃん.のコメントセクション全体のスタイル */
  .article-content :global(.technyan-comment) {
    background-color: rgba(255, 246, 208, 0.3);
    border: 2px solid #0c2340;
    border-radius: 8px;
    padding: 2rem;
    margin: 2rem 0;
    position: relative;
  }

  .article-content :global(.technyan-comment::before) {
    content: '';
    position: absolute;
    top: -1rem;
    left: 2rem;
    width: 4rem;
    height: 4rem;
    background-image: url('/technyan.webp');
    background-size: contain;
    background-repeat: no-repeat;
    background-position: center;
    background-color: #fff6d0;
    border: 2px solid #0c2340;
    border-radius: 50%;
    padding: 0.5rem;
  }

  .article-content :global(.technyan-comment h2) {
    margin-top: 0;
    padding-top: 1rem;
  }

  .article-content :global(.technyan-comment blockquote) {
    border-left-color: #0c2340;
    border-left-width: 3px;
    background-color: rgba(255, 255, 255, 0.5);
    padding: 1rem 1.5rem;
    border-radius: 4px;
    font-style: italic;
  }
</style>

<script>
  // テクにゃん.のコメントセクションを特別なスタイルでラップ
  document.addEventListener('DOMContentLoaded', () => {
    const article = document.querySelector('.article-content');
    if (!article) return;

    // 日本語版と英語版の両方に対応
    const headers = article.querySelectorAll('h2');
    headers.forEach((header) => {
      const text = header.textContent?.trim() || '';
      if (text.includes('テクにゃん.のコメント') || text.includes("Tech-nyan's Comment")) {
        // h2の直後の要素（通常はblockquote）を探す
        let nextElement = header.nextElementSibling;

        // テクにゃん.のコメントセクションをラップ
        const wrapper = document.createElement('div');
        wrapper.className = 'technyan-comment';

        // h2をラップの中に移動
        header.parentNode?.insertBefore(wrapper, header);
        wrapper.appendChild(header);

        // h2の直後の要素をラップの中に追加
        if (nextElement && (nextElement.tagName === 'P' || nextElement.tagName === 'BLOCKQUOTE')) {
          wrapper.appendChild(nextElement);
        }
      }
    });

    // 目次生成
    generateTableOfContents();

    // スクロールイベントでアクティブセクションをハイライト
    let ticking = false;
    window.addEventListener('scroll', () => {
      if (!ticking) {
        window.requestAnimationFrame(() => {
          highlightActiveSection();
          ticking = false;
        });
        ticking = true;
      }
    });
  });

  function generateTableOfContents() {
    const article = document.querySelector('.article-content');
    const tocList = document.getElementById('toc-list');

    if (!article || !tocList) return;

    const headings = article.querySelectorAll('h2');

    if (headings.length === 0) {
      // 見出しがない場合は目次を非表示
      const tocNav = document.getElementById('toc');
      if (tocNav) tocNav.style.display = 'none';
      return;
    }

    headings.forEach((heading, index) => {
      // 見出しにIDを追加（なければ）
      if (!heading.id) {
        heading.id = `section-${index}`;
      }

      // 目次アイテムを作成
      const li = document.createElement('li');
      const a = document.createElement('a');
      a.href = `#${heading.id}`;
      a.textContent = heading.textContent;
      a.className = 'toc-link block py-1 px-2 hover:bg-navy hover:text-cream transition-colors duration-200 border-l-2 border-transparent';
      a.dataset.target = heading.id;

      // クリックイベント（スムーススクロール）
      a.addEventListener('click', (e) => {
        e.preventDefault();

        // 見出しの位置を取得して、上部に余裕を持たせてスクロール
        const headingTop = heading.getBoundingClientRect().top + window.scrollY;
        const offset = 100; // 上部の余白（ピクセル）

        window.scrollTo({
          top: headingTop - offset,
          behavior: 'smooth'
        });

        // URLを更新（履歴に追加しない）
        history.replaceState(null, '', `#${heading.id}`);
      });

      li.appendChild(a);
      tocList.appendChild(li);
    });
  }

  function highlightActiveSection() {
    const article = document.querySelector('.article-content');
    if (!article) return;

    const headings = article.querySelectorAll('h2');
    const tocLinks = document.querySelectorAll('.toc-link');

    let activeIndex = -1;
    const scrollPosition = window.scrollY;
    const viewportMiddle = scrollPosition + window.innerHeight / 3; // ビューポート上部1/3の位置

    // どのセクションが現在表示されているか判定
    // 各見出しの絶対位置を取得し、ビューポートの上部1/3の位置と比較
    headings.forEach((heading, index) => {
      const rect = heading.getBoundingClientRect();
      const headingTop = rect.top + scrollPosition;

      // 次の見出しの位置を取得（最後の見出しの場合は無限大）
      const nextHeading = headings[index + 1];
      const nextHeadingTop = nextHeading
        ? nextHeading.getBoundingClientRect().top + scrollPosition
        : Infinity;

      // 現在のビューポート位置が、この見出しと次の見出しの間にあるか判定
      if (viewportMiddle >= headingTop && viewportMiddle < nextHeadingTop) {
        activeIndex = index;
      }
    });

    // すべてのリンクから active クラスを削除
    tocLinks.forEach(link => {
      link.classList.remove('active-toc-link', 'border-navy', 'bg-navy', 'text-cream', 'font-bold');
      link.classList.add('border-transparent');
    });

    // アクティブなセクションのリンクにクラスを追加
    if (activeIndex >= 0 && tocLinks[activeIndex]) {
      const activeLink = tocLinks[activeIndex];
      activeLink.classList.add('active-toc-link', 'border-navy', 'bg-navy', 'text-cream', 'font-bold');
      activeLink.classList.remove('border-transparent');
    }
  }
</script>
